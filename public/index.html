<!doctype html>
<html lang="en" data-bs-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Readability Checker</title>
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-J9RZWL9DZ5"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-J9RZWL9DZ5');
  </script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="/styles/app.css" rel="stylesheet"/>
</head>
<body>
  <div class="p-sm-3">
    <h1 class="mb-2 mb-sm-3 fs-5 fs-sm-3">Readability Checker</h1>
  
    <div class="mb-2 mb-sm-3">
      <textarea id="input" class="form-control form-control-sm" rows="6" placeholder="Paste your text here...">Learning to code is an essential skill in todays world. It allows people to create software automate tasks and solve complex problems efficiently. Beginners may feel overwhelmed at first but with consistent practice even challenging concepts become manageable. Programming languages vary in syntax and complexity yet the fundamental logic remains similar across most languages. Understanding algorithms data structures and design patterns is crucial for building reliable and scalable applications. Moreover coding fosters critical thinking problem solving and creativity. Online tutorials coding bootcamps and practice projects provide ample opportunities for learners to improve and gain confidence in their abilities.</textarea>
    </div>
  
    <div class="mb-2 mb-sm-3 d-flex gap-2">
      <button id="analyze" class="btn btn-primary btn-sm">Analyze</button>
      <button id="clear" class="btn btn-secondary btn-sm">Clear</button>
    </div>
  
    <div id="output" class="row d-none small">
      <div id="char-stats" class="col-md-12 mb-2 mb-sm-3 p-2 p-sm-3 bg-info-subtle rounded"></div>
      <div id="difficulty" class="col-md-12 mb-2 mb-sm-3 p-2 p-sm-3 bg-warning-subtle rounded border border-warning border-2"></div>
      <div id="sentence-stats" class="col-md-12 mb-2 mb-sm-3 p-2 p-sm-3 bg-success-subtle rounded"></div>
      <div id="paragraph-stats" class="col-md-12 mb-2 mb-sm-3 p-2 p-sm-3 bg-body-secondary rounded"></div>
      <div id="word-stats" class="col-md-12 mb-2 mb-sm-3 p-2 p-sm-3 bg-warning-subtle rounded"></div>
      <div id="syllable-stats" class="col-md-12 mb-2 mb-sm-3 p-2 p-sm-3 bg-warning-subtle rounded"></div>
      
    </div>
    <div id="results" class="row mb-2 mb-sm-3"></div>
  </div>
  </div>
  <script type="module">
    import { getFirestore } from "https://oangia.github.io/firebase/1.0.0/firebase.js";
    const firestore = getFirestore();
    window.firestore = firestore;
  </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/blueimp-md5/2.19.0/js/md5.min.js"></script>
  <script src="/scripts/formula.js"></script>
  <script src="/plugins/utils.js"></script>
  <script>
    class ApiHandler {
      constructor(baseUrl) {
        this.baseUrl = baseUrl;
        this.privateKey = null;
        this.publicKey = null;
      }

      // Generate ephemeral RSA key pair
      async generateKeyPair() {
        const pair = await crypto.subtle.generateKey(
          {
            name: "RSA-OAEP",
            modulusLength: 4096,
            publicExponent: new Uint8Array([1, 0, 1]),
            hash: "SHA-256"
          },
          true,
          ["encrypt", "decrypt"]
        );
        this.privateKey = pair.privateKey;
        this.publicKey = pair.publicKey;
      }

      // Export public key in Base64
      async exportPublicKey() {
        const raw = await crypto.subtle.exportKey("spki", this.publicKey);
        return btoa(String.fromCharCode(...new Uint8Array(raw)));
      }

      // Decrypt server response (Base64)
      async decryptResponse(cipherBase64) {
        const bytes = Uint8Array.from(atob(cipherBase64), c => c.charCodeAt(0));
        const decrypted = await crypto.subtle.decrypt(
          { name: "RSA-OAEP" },
          this.privateKey,
          bytes
        );
        return JSON.parse(new TextDecoder().decode(decrypted));
      }

      // Send data + public key, get decrypted response
      async post(data) {
        await this.generateKeyPair();
        const pubKey = await this.exportPublicKey();

        const response = await fetch(this.baseUrl, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ ...data, pub: pubKey })
        });
        const res = await response.json();
        const result = await this.decryptResponse(res.r);
        // Clear keys
        this.privateKey = null;
        this.publicKey = null;

        return {readability: result.r};
      }
    }
  </script>
  <script>
  document.getElementById('analyze').addEventListener('click', async () => {
    const text = document.getElementById('input').value.trim();
    if (!Validator.minLength(text, 100)) { 
      return Message.error('Input text must least be 100 characters long.', 5000); 
    }
    if (!Validator.maxLength(text, 1000)) { 
      return Message.error('Input text must not exceed 1000 characters.', 5000); 
    }
    Loading.start();
    const loopup = new ReadabilityLookup();
    const api = new ApiHandler("https://oangia.pythonanywhere.com/");
    const requestData = { text: text };
    const data = await api.post(requestData);
    const results = loopup.calculate(text, data.readability);
    showResults('results', results);
    Loading.end();
  });
  document.getElementById('clear').addEventListener('click', () => {
    document.getElementById('input').value = '';
    document.getElementById('output').classList.add('d-none');
  });
  </script>
</body>
</html>