<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Code Runner</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
<link href="/styles/app.css" rel="stylesheet">
</head>

<body class="position-relative">

<!-- User info -->
<div id="user-info" class="position-fixed top-0 end-0 m-3 bg-white shadow-sm rounded d-flex align-items-center gap-2 px-3 py-2" style="display:none;">
  <span id="user-email" class="small text-dark"></span>
  <button id="logout-btn" class="btn btn-sm btn-danger">Logout</button>
</div>

<!-- Floating settings button -->
<button class="btn btn-primary rounded-circle position-fixed bottom-0 end-0 m-4 d-flex align-items-center justify-content-center"
        style="width:60px; height:60px;" 
        data-bs-toggle="offcanvas" 
        data-bs-target="#crud-offcanvas">
  <i class="bi bi-gear-fill fs-3"></i>
</button>

<!-- Offcanvas -->
<div class="offcanvas offcanvas-start" id="crud-offcanvas">
  <div class="offcanvas-header">
    <h5 class="offcanvas-title">Files</h5>
    <button class="btn-close" data-bs-dismiss="offcanvas"></button>
  </div>

  <div class="offcanvas-body">
    <button id="add-new-file-btn" class="btn btn-success mb-3 w-100">Add New File</button>

    <div class="table-responsive">
      <table class="table table-bordered table-hover">
        <thead class="table-light">
          <tr>
            <th>Name</th>
            <th style="width:120px;">Actions</th>
          </tr>
        </thead>
        <tbody id="files"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- Modal -->
<div class="modal fade" id="file-modal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content d-flex flex-column">
      
      <div class="modal-header">
        <h5 class="modal-title" id="file-modal-label">Add/Edit File</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body d-flex flex-column gap-2 p-3 flex-grow-1">
        <input id="file-name" class="form-control" placeholder="File name">
        <textarea id="file-content" class="form-control flex-grow-1" placeholder="Write code here..."></textarea>
      </div>

      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button id="save-file-btn" class="btn btn-primary">Save</button>
      </div>

    </div>
  </div>
</div>

<!-- Iframe Code Runner -->
<div class="d-flex flex-column vh-100">
  <iframe id="code-runner" class="w-100 flex-grow-1 border"></iframe>
</div>

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://oangia.github.io/plugins/log.js"></script>

<script type="module">
import { getFirestoreWithAuth } from "https://oangia.github.io/firebase/1.0.0/firebase.js";

const firestore = getFirestoreWithAuth("guard", {
  loginUrl: "./login.html",
  logoutBtnId: "logout-btn"
});

let currentFileName = null;
const filesEl = document.getElementById("files");
const iframeEl = document.getElementById("code-runner");
const fileModalEl = document.getElementById("file-modal");
const fileModal = new bootstrap.Modal(fileModalEl);
const modalFileNameEl = document.getElementById("file-name");
const modalFileContentEl = document.getElementById("file-content");
const modalTitleEl = document.getElementById("file-modal-label");

const loadFiles = async () => {
  const filesCol = await firestore.readAll("files");
  filesEl.innerHTML = "";
  filesCol.forEach(data => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${data.name}</td>
      <td class="d-flex gap-1">
        <button class="btn btn-sm btn-success">Run</button>
        <button class="btn btn-sm btn-primary">Edit</button>
        <button class="btn btn-sm btn-danger">Delete</button>
      </td>
    `;
    const [runBtn, editBtn, delBtn] = tr.querySelectorAll("button");
    runBtn.onclick = () => {
      runCode(data.code);
      bootstrap.Offcanvas.getInstance(document.getElementById('crud-offcanvas')).hide();
    };
    editBtn.onclick = () => {
      currentFileName = data.name;
      modalTitleEl.textContent = "Edit File";
      modalFileNameEl.value = data.name;
      modalFileContentEl.value = data.code;
      fileModal.show();
    };
    delBtn.onclick = async () => {
      if (confirm("Delete this file?")) {
        await firestore.delete("files", data.name);
        if (currentFileName === data.name) iframeEl.srcdoc = "";
        loadFiles();
      }
    };
    filesEl.appendChild(tr);
  });
};

const runCode = code => {
  const doc = iframeEl.contentDocument;
  doc.open();
  doc.write(code);
  doc.close();
};

document.getElementById("add-new-file-btn").onclick = () => {
  currentFileName = null;
  modalTitleEl.textContent = "Add New File";
  modalFileNameEl.value = "";
  modalFileContentEl.value = "";
  fileModal.show();
};

document.getElementById("save-file-btn").onclick = async () => {
  const name = modalFileNameEl.value.trim();
  const code = modalFileContentEl.value;
  if (!name) return alert("Enter file name");
  if (currentFileName && name !== currentFileName) {
    await firestore.createWithId("files", name, { name, code });
    await firestore.delete("files", currentFileName);
  } else if (currentFileName) {
    await firestore.update("files", currentFileName, { code });
  } else {
    await firestore.createWithId("files", name, { name, code });
  }
  currentFileName = name;
  loadFiles();
  fileModal.hide();
};

loadFiles();
</script>

</body>
</html>
