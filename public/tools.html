<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Code Runner</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
<style>
  body, html { height:100%; margin:0; overflow: hidden; }
  #code-runner { width: 100%; height: 100%; border: none; }
  .floating-btn {
    position: fixed;
    bottom: 20px;
    right: 20px;
    z-index: 1050;
    width: 60px;
    height: 60px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
  }
  #file-content {
      height: 60vh;
  }
</style>
</head>
<body>

<button class="btn btn-primary floating-btn" type="button" data-bs-toggle="offcanvas" data-bs-target="#crud-offcanvas" aria-controls="crud-offcanvas">
  <i class="bi bi-gear-fill"></i>
</button>

<div class="offcanvas offcanvas-start" tabindex="-1" id="crud-offcanvas" aria-labelledby="crud-offcanvas-label">
  <div class="offcanvas-header">
    <h5 class="offcanvas-title" id="crud-offcanvas-label">Files</h5>
    <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
  </div>
  <div class="offcanvas-body">
    <button class="btn btn-success mb-3" id="add-new-file-btn">Add New File</button>
    <div class="table-responsive">
      <table class="table table-bordered table-hover">
        <thead>
          <tr>
            <th>Name</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="files"></tbody>
      </table>
    </div>
  </div>
</div>

<div class="modal fade" id="file-modal" tabindex="-1" aria-labelledby="file-modal-label" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="file-modal-label">Add/Edit File</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <input type="text" id="file-name" class="form-control mb-2" placeholder="File name">
        <textarea id="file-content" class="form-control" placeholder="Write code here..."></textarea>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary" id="save-file-btn">Save</button>
      </div>
    </div>
  </div>
</div>

<iframe id="code-runner"></iframe>

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script type="module">
// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyB0TxR5HpNJ8Ph7rnrHqXNMAmBWo1dw5Nw",
  authDomain: "agent52.firebaseapp.com",
  projectId: "agent52",
  storageBucket: "agent52.firebasestorage.app",
  messagingSenderId: "534394830199",
  appId: "1:534394830199:web:521b810d19dbcfe9edb572",
  measurementId: "G-J9RZWL9DZ5"
};
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import { getFirestore, collection, getDocs, doc, setDoc, updateDoc, deleteDoc, getDoc } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const filesCol = collection(db, "files");

let currentFileName = null;

const filesEl = document.getElementById("files");
const iframeEl = document.getElementById("code-runner");
const fileModalEl = document.getElementById('file-modal');
const fileModal = new bootstrap.Modal(fileModalEl);

const modalFileNameEl = fileModalEl.querySelector('#file-name');
const modalFileContentEl = fileModalEl.querySelector('#file-content');
const modalTitleEl = fileModalEl.querySelector('#file-modal-label');

const loadFiles = async () => {
  filesEl.innerHTML = "";
  const snapshot = await getDocs(filesCol);
  snapshot.forEach(docSnap => {
    const data = docSnap.data();
    const tr = document.createElement("tr");

    const nameTd = document.createElement("td");
    nameTd.textContent = data.name;
    tr.appendChild(nameTd);

    const actionsTd = document.createElement("td");

    const runBtn = document.createElement("button");
    runBtn.textContent = "Run";
    runBtn.className = "btn btn-sm btn-success me-1";
    runBtn.onclick = () => {
        runCode(data.code);
        const offcanvas = bootstrap.Offcanvas.getInstance(document.getElementById('crud-offcanvas'));
        offcanvas.hide();
    }

    const editBtn = document.createElement("button");
    editBtn.textContent = "Edit";
    editBtn.className = "btn btn-sm btn-primary me-1";
    editBtn.onclick = () => {
      currentFileName = data.name;
      modalTitleEl.textContent = "Edit File";
      modalFileNameEl.value = data.name;
      modalFileContentEl.value = data.code;
      fileModal.show();
    };

    const deleteBtn = document.createElement("button");
    deleteBtn.textContent = "Delete";
    deleteBtn.className = "btn btn-sm btn-danger";
    deleteBtn.onclick = async () => {
      if (confirm("Delete this file?")) {
        await deleteDoc(doc(db, "files", data.name));
        if (currentFileName === data.name) {
          currentFileName = null;
          iframeEl.srcdoc = '';
        }
        loadFiles();
      }
    };

    actionsTd.append(runBtn, editBtn, deleteBtn);
    tr.appendChild(actionsTd);
    filesEl.appendChild(tr);
  });
};

const runCode = (code) => {
  const docFrame = iframeEl.contentDocument || iframeEl.contentWindow.document;
  docFrame.open();
  docFrame.write(code);
  docFrame.close();
};

document.getElementById('add-new-file-btn').onclick = () => {
    currentFileName = null;
    modalTitleEl.textContent = 'Add New File';
    modalFileNameEl.value = '';
    modalFileContentEl.value = '';
    fileModal.show();
};

document.getElementById('save-file-btn').onclick = async () => {
  const name = modalFileNameEl.value.trim();
  const code = modalFileContentEl.value;

  if (!name) return alert("Enter file name");

  if (currentFileName && name !== currentFileName) {
    await setDoc(doc(db, "files", name), { name, code });
    await deleteDoc(doc(db, "files", currentFileName));
  } else if (currentFileName) {
    await updateDoc(doc(db, "files", currentFileName), { code });
  } else {
    await setDoc(doc(db, "files", name), { name, code });
  }
  
  currentFileName = name;
  loadFiles();
  fileModal.hide();
};

loadFiles();
</script>
</body>
</html>