<!DOCTYPE html>
<html>
<head>
  <title>Firestore Export / Import</title>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
    import { getFirestore, collection, doc, setDoc, getDocs } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";

    let db;

    function parseConfig(configText) {
      try {
        return JSON.parse(configText);
      } catch (e) {
        try {
          return Function('"use strict";return (' + configText + ")")();
        } catch (err) {
          alert("Invalid Firebase config. Must be JSON or JS-style object.");
          return null;
        }
      }
    }

    function initFirestore(configText) {
      const config = parseConfig(configText);
      if (!config) return false;
      const app = initializeApp(config);
      db = getFirestore(app);
      return true;
    }

    async function exportFirestore(collectionsText) {
      if (!db) { alert("Initialize Firestore first"); return; }

      const collections = collectionsText.split(",").map(c => c.trim());
      const allData = {};

      for (const col of collections) {
        const colRef = collection(db, col);
        const snapshot = await getDocs(colRef);
        allData[col] = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      }

      const blob = new Blob([JSON.stringify(allData, null, 2)], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "firestore-export.json";
      a.click();
      URL.revokeObjectURL(url);

      console.log("Export complete!");
    }

    async function importFirestore(file) {
      if (!db) { alert("Initialize Firestore first"); return; }

      const text = await file.text();
      let allData;
      try {
        allData = JSON.parse(text);
      } catch (e) {
        alert("Invalid JSON file");
        return;
      }

      for (const colName in allData) {
        const colRef = collection(db, colName);
        for (const docData of allData[colName]) {
          const docRef = doc(colRef, docData.id);
          const dataCopy = { ...docData };
          delete dataCopy.id; // remove id field
          await setDoc(docRef, dataCopy);
        }
      }

      alert("Import complete!");
    }

    window.runExport = () => {
      const configText = document.getElementById("config").value;
      const collectionsText = document.getElementById("collections").value;
      if (!initFirestore(configText)) return;
      exportFirestore(collectionsText);
    };

    window.runImport = () => {
      const configText = document.getElementById("config").value;
      const fileInput = document.getElementById("jsonFile");
      if (!fileInput.files.length) { alert("Select a JSON file"); return; }
      if (!initFirestore(configText)) return;
      importFirestore(fileInput.files[0]);
    };
  </script>
</head>
<body>
  <h1>Firestore Export / Import</h1>

  <p>Paste Firebase config (JSON or JS-style object):</p>
  <textarea id="config" rows="10" cols="60"></textarea>

  <p>Collections (comma separated for export):</p>
  <input type="text" id="collections" size="60" placeholder="users,posts,...">

  <br><br>
  <button onclick="runExport()">Export Firestore</button>

  <hr>
  <p>Select JSON file to import:</p>
  <input type="file" id="jsonFile" accept=".json">
  <br><br>
  <button onclick="runImport()">Import JSON into Firestore</button>
</body>
</html>
