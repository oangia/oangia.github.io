<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Forever Data Form</title>
<script type="module">
  // Import Firebase SDK
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-app.js";
  import { getFirestore, collection, addDoc, getDocs, query, where, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-firestore.js";
  import { firebaseConfig } from "https://oangia.github.io/plugins/firebasejs/1.0.0/config.js";

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  window.addEventListener('DOMContentLoaded', async () => {

  const editor = new BlogEditor('editor-container');  // Your BlogEditor
  const form = document.getElementById('forever-form');
  const aliasInput = document.getElementById('alias');
  const aliasList = document.getElementById('alias-list');
  const contentDisplay = document.getElementById('content-display');

  // --- Add new data ---
  form.addEventListener('submit', async e => {
    e.preventDefault();
    const alias = aliasInput.value.trim();
    const content = editor.getContent();
    if (!alias || !content) return alert("Alias and content required!");

    try {
      await addDoc(collection(db, "forever"), { alias, content, timestamp: new Date() });
      aliasInput.value = '';
      editor.editor.innerHTML = '';
      await loadAliases();
      alert("Saved successfully!");
    } catch (err) {
      console.error(err);
      alert("Error saving data");
    }
  });

  // --- Load all unique aliases ---
  async function loadAliases() {
    aliasList.innerHTML = '';
    const snapshot = await getDocs(collection(db, "forever"));
    const aliasMap = {}; // store latest timestamp per alias

    snapshot.docs.forEach(doc => {
      const data = doc.data();
      if (!aliasMap[data.alias] || (data.timestamp?.second > aliasMap[data.alias].timestamp)) {
        aliasMap[data.alias] = { id: doc.id, timestamp: data.timestamp.second };
      }
    });

    Object.entries(aliasMap).forEach(([alias, info]) => {
      const btn = document.createElement('button');
      btn.type = 'button';
      const timeStr = info.timestamp ? new Date(info.timestamp.second).toLocaleString() : 'Unknown';
      btn.innerText = `${alias} (${timeStr})`;
      btn.addEventListener('click', () => showLatestContent(alias));
      aliasList.appendChild(btn);
    });
  }

  // --- Show latest content for an alias ---
  async function showLatestContent(alias) {
    const q = query(
      collection(db, "forever"),
      where("alias", "==", alias),
      orderBy("timestamp", "desc"), // assuming you store a timestamp
      limit(1)
    );
    const snapshot = await getDocs(q);
    if (!snapshot.empty) {
      const doc = snapshot.docs[0].data();
      if (/<[^>]+>/.test(doc.content)) {
        contentDisplay.innerHTML = `${doc.content}`;
      } else {
        contentDisplay.innerHTML = `<pre>${doc.content}</pre>`;
      }
    } else {
      contentDisplay.textContent = 'No content found';
    }
  }

  await loadAliases();
});
</script>
<script src="/plugins/editor/1.0.0/editor.js"></script>
<style>
/* Toolbar buttons stay inline */
.toolbar {
  display: flex;
  flex-wrap: wrap;
  gap: 4px;
  margin-bottom: 10px;
  align-items: center;
}

.toolbar button {
  type: button;        /* JS ensures type="button" for all editor buttons */
  display: inline-flex; 
  align-items: center;
  justify-content: center;
  width: auto;          /* important: don't stretch full width */
  min-width: 32px;
  padding: 5px 8px;
  border: 1px solid #ccc;
  border-radius: 4px;
  background: #f9f9f9;
  cursor: pointer;
}

.toolbar button:hover {
  background: #e0e0e0;
}

.toolbar .separator {
  margin: 0 4px;
  color: #888;
  user-select: none;
}

/* Form submit button full width */
#forever-form button[type="submit"] {
  width: 100%;
  padding: 8px;
  margin-top: 10px;
  background: #4285f4;
  color: #fff;
  border: none;
  border-radius: 4px;
  cursor: pointer;
}

#forever-form button[type="submit"]:hover {
  background: #357ae8;
}

/* Alias list buttons */
#alias-list button {
  padding: 5px 10px;
  cursor: pointer;
  margin: 3px;
}

/* Display content box */
#content-display {
  border: 1px solid #ccc;
  min-height: 200px;
  padding: 10px;
  border-radius: 4px;
  margin-top: 10px;
}

</style>
</head>
<body>

<h2>Create Forever Data</h2>
<form id="forever-form">
  <input type="text" id="alias" placeholder="Alias" required>
  <div id="editor-container"></div>
  <button type="submit">Create</button>
</form>

<h2>All Aliases</h2>
<div id="alias-list"></div>

<h2>Latest Content</h2>
<div id="content-display"></div>

</body>
</html>
