<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Forever Data Form</title>
  
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="style.css" rel="stylesheet"/>
  <script type="module">
    // Import Firebase SDK
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, query, where, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-firestore.js";
    import { firebaseConfig } from "https://oangia.github.io/plugins/firebasejs/1.0.0/config.js";

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    window.addEventListener('DOMContentLoaded', async () => {
      const editor = new BlogEditor('editor-container');
      const form = document.getElementById('forever-form');
      const aliasInput = document.getElementById('alias');
      const aliasList = document.getElementById('alias-list');
      const contentDisplay = document.getElementById('content-display');

      // Add new data
      form.addEventListener('submit', async e => {
        e.preventDefault();
        const alias = aliasInput.value.trim();
        const content = editor.getContent();
        if (!alias || !content) return alert("Alias and content required!");

        try {
          await addDoc(collection(db, "forever"), { alias, content, timestamp: new Date() });
          aliasInput.value = '';
          editor.editor.innerHTML = '';
          await loadAliases();
          alert("Saved successfully!");
        } catch (err) {
          console.error(err);
          alert("Error saving data");
        }
      });

      // Load all unique aliases
      async function loadAliases() {
        aliasList.innerHTML = '';
        const snapshot = await getDocs(collection(db, "forever"));
        const aliasMap = {};

        snapshot.docs.forEach(doc => {
          const data = doc.data();
          if (!aliasMap[data.alias] || (data.timestamp?.second > aliasMap[data.alias].timestamp)) {
            aliasMap[data.alias] = { id: doc.id, timestamp: data.timestamp?.second };
          }
        });

        Object.entries(aliasMap).forEach(([alias, info]) => {
          const btn = document.createElement('button');
          btn.type = 'button';
          btn.className = 'btn btn-outline-primary btn-sm me-2 mb-2';
          const timeStr = info.timestamp ? new Date(info.timestamp * 1000).toLocaleString() : 'Unknown';
          btn.innerText = `${alias} (${timeStr})`;
          btn.addEventListener('click', () => showLatestContent(alias));
          aliasList.appendChild(btn);
        });
      }

      // Show latest content
      async function showLatestContent(alias) {
        const q = query(
          collection(db, "forever"),
          where("alias", "==", alias),
          orderBy("timestamp", "desc"),
          limit(1)
        );
        const snapshot = await getDocs(q);
        if (!snapshot.empty) {
          const doc = snapshot.docs[0].data();
          contentDisplay.innerHTML = /<[^>]+>/.test(doc.content) ? doc.content : `<pre>${doc.content}</pre>`;
        } else {
          contentDisplay.textContent = 'No content found';
        }
      }

      await loadAliases();
    });
  </script>
  
  <script src="/plugins/editor/1.0.0/editor.js"></script>
</head>
<body class="container py-4">

  <h2>Create Forever Data</h2>
  <form id="forever-form" class="mb-4">
    <input type="text" id="alias" class="form-control mb-2" placeholder="Alias" required>
    <div id="editor-container" class="mb-2"></div>
    <button type="submit" class="btn btn-primary w-100">Create</button>
  </form>

  <h2>All Aliases</h2>
  <div id="alias-list" class="mb-4 d-flex flex-wrap"></div>

  <h2>Latest Content</h2>
  <div id="content-display" class="border p-3 rounded bg-white" style="min-height:200px;"></div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>